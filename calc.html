<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trade Calculator â€” JBLX</title>
  <link rel="icon" type="image/png" href="assets/images/favicon.png">
  <link rel="stylesheet" href="css/styles.css" />
  <link rel="stylesheet" href="css/mobile-nav.css" />
  <script src="js/theme.js"></script>
  <style>
/* ================================================================
   CALC PAGE  â€”  Trade Value Calculator
================================================================ */

.calc-main {
  flex: 1;
  max-width: 1320px;
  width: 100%;
  margin: 0 auto;
  padding: 26px 24px 72px;
  display: flex;
  flex-direction: column;
  gap: 22px;
}

/* â”€â”€ PAGE HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.calc-page-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 12px;
  flex-wrap: wrap;
  animation: fadeUp 0.28s var(--ease) both;
}
.calc-page-title {
  font-family: var(--font-display);
  font-size: 1.45rem;
  font-weight: 700;
  letter-spacing: 0.06em;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 10px;
  line-height: 1.1;
}
.calc-page-title svg { color: var(--accent); flex-shrink: 0; }
.calc-page-sub {
  font-size: 0.77rem;
  color: var(--text-dim);
  margin-top: 4px;
  line-height: 1.5;
}

/* Header action buttons */
.header-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  align-items: flex-start;
  flex-shrink: 0;
}
.btn-action {
  padding: 8px 16px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r);
  font-family: var(--font-display);
  font-size: 0.76rem;
  font-weight: 700;
  letter-spacing: 0.07em;
  text-transform: uppercase;
  color: var(--text-dim);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 7px;
  transition: color 0.15s, border-color 0.15s, background 0.15s;
}
.btn-action:hover {
  color: #e03040;
  border-color: rgba(224,48,64,0.35);
  background: rgba(224,48,64,0.06);
}

/* â”€â”€ ARENA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.trade-arena {
  display: grid;
  grid-template-columns: 1fr 50px 1fr;
  gap: 0;
  align-items: start;
  animation: fadeUp 0.34s var(--ease) 0.04s both;
}

.trade-vs {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding-top: 86px;
}
.vs-dot-top, .vs-dot-bot {
  width: 2px;
  min-height: 28px;
  flex: 1;
  background: linear-gradient(to bottom, transparent, var(--border-hi));
}
.vs-dot-bot { background: linear-gradient(to bottom, var(--border-hi), transparent); }
.vs-pill {
  width: 34px; height: 34px;
  border-radius: 50%;
  background: var(--surface);
  border: 1.5px solid var(--border-hi);
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--font-display);
  font-size: 0.68rem;
  font-weight: 700;
  letter-spacing: 0.06em;
  color: var(--text-dim);
  flex-shrink: 0;
  z-index: 1;
}

/* â”€â”€ PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.trade-panel {
  display: flex;
  flex-direction: column;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r-xl);
  overflow: visible;
  min-height: 480px;
  transition: border-color 0.2s;
}
.panel-offer   { border-color: rgba(0,200,240,0.2); }
.panel-request { border-color: rgba(255,126,179,0.2); }

.panel-header {
  padding: 14px 16px 12px;
  border-bottom: 1px solid var(--border);
  border-radius: var(--r-xl) var(--r-xl) 0 0;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  flex-wrap: wrap;
}
.panel-offer   .panel-header { background: linear-gradient(110deg, rgba(0,200,240,0.055) 0%, transparent 60%); }
.panel-request .panel-header { background: linear-gradient(110deg, rgba(255,126,179,0.055) 0%, transparent 60%); }

.panel-label {
  font-family: var(--font-display);
  font-size: 0.9rem;
  font-weight: 700;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  display: flex;
  align-items: center;
  gap: 9px;
}
.panel-offer   .panel-label { color: var(--accent); }
.panel-request .panel-label { color: #ff7eb3; }

.panel-dot {
  width: 7px; height: 7px;
  border-radius: 50%;
  flex-shrink: 0;
}
.panel-offer   .panel-dot { background: var(--accent); box-shadow: 0 0 7px var(--accent); }
.panel-request .panel-dot { background: #ff7eb3; box-shadow: 0 0 7px #ff7eb3; }

/* Panel right side: total + controls */
.panel-header-right {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-shrink: 0;
}

.panel-total-group { text-align: right; }
.panel-total-lbl {
  display: block;
  font-family: var(--font-mono);
  font-size: 0.5rem;
  letter-spacing: 0.14em;
  text-transform: uppercase;
  color: var(--text-muted);
  margin-bottom: 1px;
}
.panel-total-val {
  display: block;
  font-family: var(--font-mono);
  font-size: 1.05rem;
  font-weight: 700;
  transition: color 0.15s;
}
.panel-offer   .panel-total-val { color: var(--accent); }
.panel-request .panel-total-val { color: #ff7eb3; }

/* Panel control buttons */
.panel-ctrl-btns {
  display: flex;
  gap: 4px;
}
.panel-ctrl-btn {
  padding: 5px 10px;
  border-radius: var(--r);
  font-family: var(--font-mono);
  font-size: 0.58rem;
  font-weight: 700;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  border: 1px solid var(--border);
  background: var(--bg3);
  color: var(--text-muted);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 4px;
  white-space: nowrap;
  transition: color 0.14s, border-color 0.14s, background 0.14s;
}
.panel-ctrl-btn:hover {
  color: var(--text);
  border-color: var(--border-hi);
  background: var(--surface2);
}
.panel-ctrl-btn.mirror-btn:hover {
  color: var(--accent);
  border-color: rgba(0,200,240,0.35);
  background: rgba(0,200,240,0.07);
}
.panel-ctrl-btn.clear-btn:hover {
  color: #e03040;
  border-color: rgba(224,48,64,0.35);
  background: rgba(224,48,64,0.06);
}

/* â”€â”€ SEARCH SECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.panel-search-wrap {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  position: relative;
}
.panel-search-icon {
  position: absolute;
  left: 27px; top: 50%; transform: translateY(-50%);
  width: 14px; height: 14px;
  color: var(--text-muted);
  pointer-events: none;
}
.panel-search-input {
  width: 100%;
  padding: 9px 12px 9px 34px;
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: var(--r);
  color: var(--text);
  font-family: var(--font-body);
  font-size: 0.82rem;
  outline: none;
  transition: border-color 0.15s, box-shadow 0.15s;
}
.panel-search-input::placeholder { color: var(--text-muted); }
.panel-offer   .panel-search-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(0,200,240,0.10); }
.panel-request .panel-search-input:focus { border-color: #ff7eb3; box-shadow: 0 0 0 3px rgba(255,126,179,0.10); }

/* â”€â”€ DROPDOWN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.search-results-dropdown {
  display: none;
  position: absolute;
  top: calc(100% - 4px);
  left: 0; right: 0;
  z-index: 400;
  background: var(--surface);
  border: 1px solid var(--border-hi);
  border-radius: var(--r-lg);
  box-shadow: 0 18px 54px rgba(0,0,0,0.6);
  overflow: hidden;
  flex-direction: column;
}
.search-results-dropdown.open { display: flex; }

.srd-header {
  padding: 7px 14px 5px;
  background: var(--bg3);
  border-bottom: 1px solid var(--border);
  font-family: var(--font-mono);
  font-size: 0.53rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--text-muted);
  flex-shrink: 0;
}
.srd-scroll { overflow-y: auto; max-height: 320px; }

.srd-row {
  display: grid;
  grid-template-columns: 42px 1fr 80px auto 58px;
  align-items: center;
  gap: 10px;
  padding: 9px 14px;
  border-bottom: 1px solid var(--border);
  transition: background 0.09s;
}
.srd-row:last-child { border-bottom: none; }
.srd-row:hover { background: var(--surface2); }

.srd-thumb {
  width: 40px; height: 32px;
  border-radius: 5px;
  background: var(--bg3);
  border: 1px solid var(--border);
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}
.srd-thumb img { width: 100%; height: 100%; object-fit: cover; display: block; }
.srd-thumb-fb {
  font-family: var(--font-display);
  font-size: 0.54rem;
  font-weight: 700;
  color: var(--accent);
  opacity: 0.55;
  letter-spacing: 0.03em;
}
.srd-name {
  font-family: var(--font-display);
  font-size: 0.88rem;
  font-weight: 600;
  color: var(--text);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.srd-type {
  font-family: var(--font-mono);
  font-size: 0.56rem;
  color: var(--text-muted);
  margin-top: 1px;
}
.srd-val {
  font-family: var(--font-mono);
  font-size: 0.8rem;
  font-weight: 700;
  color: #ffd166;
  text-align: right;
  white-space: nowrap;
  flex-shrink: 0;
}
.srd-demand { flex-shrink: 0; }
.srd-add {
  padding: 5px 0;
  width: 52px;
  border-radius: var(--r);
  font-family: var(--font-display);
  font-size: 0.7rem;
  font-weight: 700;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 3px;
  flex-shrink: 0;
  transition: opacity 0.14s, transform 0.12s;
}
.panel-offer   .srd-add { background: var(--accent); color: #000; }
.panel-request .srd-add { background: #ff7eb3; color: #000; }
.srd-add:hover  { opacity: 0.82; transform: scale(1.04); }
.srd-add:active { transform: scale(0.97); }
.srd-empty {
  padding: 22px;
  text-align: center;
  font-size: 0.78rem;
  color: var(--text-muted);
  font-style: italic;
}

/* â”€â”€ SELECTED ITEMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.panel-selected-wrap { flex: 1; display: flex; flex-direction: column; }

.panel-empty-state {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 10px;
  padding: 36px 24px;
  text-align: center;
  color: var(--text-muted);
}
.panel-empty-state svg { opacity: 0.12; }
.panel-empty-state-title {
  font-family: var(--font-display);
  font-size: 0.82rem;
  font-weight: 600;
  letter-spacing: 0.06em;
  color: var(--text-dim);
  margin-bottom: 2px;
}
.panel-empty-state-sub { font-size: 0.72rem; font-style: italic; }

.selected-list { overflow-y: auto; max-height: 480px; }

.sel-row {
  display: grid;
  grid-template-columns: 44px 1fr auto;
  align-items: center;
  gap: 10px;
  padding: 9px 14px;
  border-bottom: 1px solid var(--border);
  transition: background 0.09s;
  animation: fadeUp 0.16s var(--ease) both;
}
.sel-row:last-child { border-bottom: none; }
.sel-row:hover { background: var(--surface2); }

.sel-thumb-wrap {
  position: relative;
  width: 40px; height: 34px;
  border-radius: 6px;
  background: var(--bg3);
  border: 1px solid var(--border);
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}
.sel-thumb-wrap img { width: 100%; height: 100%; object-fit: cover; display: block; }
.sel-thumb-fb {
  font-family: var(--font-display);
  font-size: 0.55rem;
  font-weight: 700;
  color: var(--accent);
  opacity: 0.5;
  letter-spacing: 0.04em;
}
.sel-duped-strip {
  display: none;
  position: absolute;
  bottom: 0; left: 0; right: 0;
  background: rgba(224,48,64,0.85);
  font-family: var(--font-mono);
  font-size: 0.4rem;
  font-weight: 700;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  text-align: center;
  color: #fff;
  padding: 1px 0;
}
.sel-row.is-duped .sel-duped-strip { display: block; }

.sel-info { min-width: 0; }
.sel-name-row {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 2px;
}
.sel-name {
  font-family: var(--font-display);
  font-size: 0.86rem;
  font-weight: 600;
  color: var(--text);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.sel-qty-badge {
  flex-shrink: 0;
  font-family: var(--font-mono);
  font-size: 0.62rem;
  font-weight: 700;
  color: var(--accent);
  background: var(--accent-glow);
  border: 1px solid var(--border-hi);
  border-radius: 4px;
  padding: 1px 5px;
  letter-spacing: 0.02em;
}
.sel-value-row {
  display: flex;
  align-items: baseline;
  gap: 5px;
}
.sel-value {
  font-family: var(--font-mono);
  font-size: 0.8rem;
  font-weight: 700;
  color: #ffd166;
  transition: color 0.2s;
}
.sel-each {
  font-family: var(--font-mono);
  font-size: 0.58rem;
  color: var(--text-muted);
  letter-spacing: 0.02em;
}

/* Right controls column */
.sel-controls {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 5px;
  flex-shrink: 0;
}

/* Qty stepper */
.qty-stepper {
  display: inline-flex;
  align-items: center;
  border-radius: 6px;
  border: 1px solid var(--border);
  overflow: hidden;
  background: var(--bg3);
}
.qty-btn {
  width: 22px;
  height: 22px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--font-mono);
  font-size: 0.85rem;
  font-weight: 700;
  color: var(--text-dim);
  background: transparent;
  border: none;
  cursor: pointer;
  line-height: 1;
  transition: color 0.12s, background 0.12s;
}
.qty-btn:hover { color: var(--accent); background: var(--accent-glow-sm); }
.qty-btn:active { transform: scale(0.9); }
.qty-display {
  font-family: var(--font-mono);
  font-size: 0.65rem;
  font-weight: 700;
  color: var(--text);
  min-width: 18px;
  text-align: center;
  letter-spacing: 0.02em;
  border-left: 1px solid var(--border);
  border-right: 1px solid var(--border);
  padding: 0 2px;
  line-height: 22px;
  height: 22px;
}

/* Clean/Duped toggle */
.cd-toggle {
  display: inline-flex;
  border-radius: 6px;
  border: 1px solid var(--border);
  overflow: hidden;
}
.cd-btn {
  padding: 3px 8px;
  font-family: var(--font-mono);
  font-size: 0.55rem;
  font-weight: 700;
  letter-spacing: 0.04em;
  cursor: pointer;
  border: none;
  background: var(--bg3);
  color: var(--text-muted);
  transition: background 0.14s, color 0.14s;
  line-height: 1.4;
  white-space: nowrap;
}
.cd-btn.active-clean { background: rgba(57,224,122,0.16); color: #39e07a; }
.cd-btn.active-duped { background: rgba(224,48,64,0.16);  color: #e03040; }
.cd-btn:disabled { opacity: 0.28; cursor: not-allowed; }

.sel-remove {
  width: 20px; height: 20px;
  border-radius: 50%;
  background: rgba(224,48,64,0.07);
  color: var(--c-falling);
  border: 1px solid rgba(224,48,64,0.15);
  font-size: 0.68rem;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: background 0.12s, transform 0.12s;
  line-height: 1;
}
.sel-remove:hover { background: rgba(224,48,64,0.22); transform: scale(1.12); }

/* â”€â”€ SUMMARY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.trade-summary { animation: fadeUp 0.38s var(--ease) 0.1s both; }

.summary-placeholder {
  background: var(--surface);
  border: 1px dashed var(--border-hi);
  border-radius: var(--r-xl);
  padding: 28px;
  text-align: center;
  color: var(--text-muted);
  font-size: 0.78rem;
  font-style: italic;
}

.summary-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r-xl);
  overflow: hidden;
  transition: border-color 0.3s;
}
.summary-card.s-win         { border-color: rgba(57,224,122,0.45); }
.summary-card.s-slight-win  { border-color: rgba(57,224,122,0.22); }
.summary-card.s-fair        { border-color: rgba(90,96,128,0.35); }
.summary-card.s-slight-lose { border-color: rgba(224,120,32,0.35); }
.summary-card.s-lose        { border-color: rgba(224,48,64,0.45); }

.summary-top {
  display: flex;
  align-items: stretch;
  flex-wrap: wrap;
  border-bottom: 1px solid var(--border);
}

.verdict-block {
  padding: 22px 26px;
  display: flex;
  align-items: center;
  gap: 14px;
  flex-shrink: 0;
  border-right: 1px solid var(--border);
  min-width: 185px;
}
.s-win        .verdict-block { background: linear-gradient(120deg, rgba(57,224,122,0.09) 0%, transparent 100%); }
.s-slight-win .verdict-block { background: linear-gradient(120deg, rgba(57,224,122,0.05) 0%, transparent 100%); }
.s-fair       .verdict-block { background: transparent; }
.s-slight-lose .verdict-block { background: linear-gradient(120deg, rgba(224,120,32,0.06) 0%, transparent 100%); }
.s-lose       .verdict-block { background: linear-gradient(120deg, rgba(224,48,64,0.08) 0%, transparent 100%); }

.verdict-emoji { font-size: 1.8rem; line-height: 1; flex-shrink: 0; }
.verdict-status {
  font-family: var(--font-display);
  font-size: 1.35rem;
  font-weight: 700;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  line-height: 1;
  margin-bottom: 3px;
}
.s-win         .verdict-status { color: #39e07a; }
.s-slight-win  .verdict-status { color: #7de8a6; }
.s-fair        .verdict-status { color: var(--text-dim); }
.s-slight-lose .verdict-status { color: #e07820; }
.s-lose        .verdict-status { color: #e03040; }
.verdict-sub {
  font-family: var(--font-mono);
  font-size: 0.5rem;
  letter-spacing: 0.13em;
  text-transform: uppercase;
  color: var(--text-muted);
}

.metrics-strip {
  flex: 1;
  display: flex;
  align-items: stretch;
  flex-wrap: wrap;
}
.metric-cell {
  padding: 14px 18px;
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  justify-content: center;
  gap: 2px;
  min-width: 90px;
}
.metric-cell:last-child { border-right: none; }
.mc-lbl {
  font-family: var(--font-mono);
  font-size: 0.5rem;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--text-muted);
}
.mc-val {
  font-family: var(--font-mono);
  font-size: 0.88rem;
  font-weight: 700;
  color: var(--text);
  white-space: nowrap;
}
.mc-val.up   { color: #39e07a; }
.mc-val.dn   { color: #e03040; }
.mc-val.warn { color: #e07820; }
.mc-val.neu  { color: var(--text-dim); }

/* Alert banners */
.summary-alert {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  padding: 10px 20px;
  font-size: 0.74rem;
  line-height: 1.5;
  border-top: 1px solid var(--border);
}
.summary-alert svg { flex-shrink: 0; margin-top: 1px; opacity: 0.9; }
.summary-alert.alert-upgrade {
  background: rgba(57,224,122,0.06);
  border-color: rgba(57,224,122,0.2);
  color: #5dd68a;
}
.summary-alert.alert-downgrade {
  background: rgba(224,48,64,0.06);
  border-color: rgba(224,48,64,0.2);
  color: #e05060;
}
.summary-alert.alert-demand {
  background: rgba(224,120,32,0.06);
  border-color: rgba(224,120,32,0.2);
  color: #c88830;
}

/* Detail grid */
.summary-detail-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(155px, 1fr));
  border-top: 1px solid var(--border);
}
.detail-block {
  padding: 13px 18px;
  border-right: 1px solid var(--border);
  border-bottom: 1px solid var(--border);
}
.detail-block:last-child { border-right: none; }
.db-lbl {
  font-family: var(--font-mono);
  font-size: 0.5rem;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--text-muted);
  margin-bottom: 4px;
}
.db-val {
  font-family: var(--font-mono);
  font-size: 0.84rem;
  font-weight: 700;
  color: var(--text);
}
.db-val.up { color: #39e07a; }
.db-val.dn { color: #e03040; }
.db-val.warn { color: #e07820; }
.db-val.neu { color: var(--text-dim); }

.conf-track {
  height: 3px;
  background: var(--border);
  border-radius: 99px;
  overflow: hidden;
  margin-top: 6px;
}
.conf-fill {
  height: 100%;
  border-radius: 99px;
  transition: width 0.55s var(--ease), background 0.3s;
}

/* â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 860px) {
  .trade-arena { grid-template-columns: 1fr; }
  .trade-vs { flex-direction: row; padding: 10px 0; justify-content: center; }
  .vs-dot-top, .vs-dot-bot {
    width: 50px; height: 2px; min-height: unset; flex: none;
    background: linear-gradient(to right, transparent, var(--border-hi));
  }
  .vs-dot-bot { background: linear-gradient(to right, var(--border-hi), transparent); }
  .summary-top { flex-direction: column; }
  .verdict-block { border-right: none; border-bottom: 1px solid var(--border); min-width: unset; }
}
@media (max-width: 560px) {
  .calc-main { padding: 16px 12px 52px; }
  .srd-row { grid-template-columns: 36px 1fr auto; }
  .srd-val, .srd-demand { display: none; }
  .metric-cell { min-width: 80px; padding: 10px 12px; }
  .panel-ctrl-btn span { display: none; }
}
  </style>
</head>
<body>

  <!-- â”€â”€ TOP NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <nav class="top-nav">
    <a href="index.html" class="nav-brand">
      <img src="assets/images/jblx-logo.png" alt="JBLX" />
    </a>
    <div class="nav-links">
      <a href="values.html" class="nav-link">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="14" height="14"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>
        <span>Values</span>
      </a>
      <a href="dupe.html" class="nav-link">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="14" height="14">
          <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
          <line x1="12" y1="9" x2="12" y2="13"/>
          <line x1="12" y1="17" x2="12.01" y2="17"/>
        </svg>
        <span>Dupe</span>
      </a>
      <a href="calc.html" class="nav-link active">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="14" height="14"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="8" y1="10" x2="16" y2="10"/><line x1="8" y1="14" x2="12" y2="14"/></svg>
        <span>Calculator</span>
      </a>
      <a href="info.html" class="nav-link">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="14" height="14"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
        <span>Info</span>
      </a>
      <a href="teams.html" class="nav-link">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="14" height="14"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        <span>Team</span>
      </a>
      <a href="disc.html" class="nav-link">
        <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03z"/></svg>
        <span>Discord</span>
      </a>
      <button class="theme-toggle" id="theme-toggle" title="Toggle theme">
        <span class="toggle-icon">â˜€</span>
      </button>
    </div>
  </nav>

  <!-- â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <main class="calc-main">

    <!-- Page header -->
    <div class="calc-page-header">
      <div>
        <div class="calc-page-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="20" height="20">
            <path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/>
          </svg>
          Trade Value Calculator
        </div>
        <div class="calc-page-sub">Search items Â· toggle Clean / Duped / Limited Â· stack quantities Â· get an instant trade verdict. <a href="info.html" style="color:var(--accent);text-decoration:underline;text-underline-offset:3px;">How does this work?</a></div>
      </div>
      <div class="header-actions">
        <button class="btn-action" id="btn-clear">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="13" height="13"><path d="M3 6h18"/><path d="M8 6V4h8v2"/><path d="M19 6l-1 14H6L5 6"/></svg>
          Clear All
        </button>
      </div>
    </div>

    <!-- Trade arena -->
    <div class="trade-arena">

      <!-- â”€â”€ OFFERING PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div class="trade-panel panel-offer">
        <div class="panel-header">
          <div class="panel-label">
            <div class="panel-dot"></div>
            You Offer
          </div>
          <div class="panel-header-right">
            <div class="panel-ctrl-btns">
              <button class="panel-ctrl-btn mirror-btn" id="mirror-offer-to-request" title="Copy offer items to request side">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="11" height="11"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                <span>Mirror</span>
              </button>
              <button class="panel-ctrl-btn clear-btn" id="clear-offer" title="Clear offer items">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="11" height="11"><path d="M3 6h18"/><path d="M19 6l-1 14H6L5 6"/></svg>
                <span>Clear</span>
              </button>
            </div>
            <div class="panel-total-group">
              <span class="panel-total-lbl">Total Value</span>
              <span class="panel-total-val" id="offer-total">0</span>
            </div>
          </div>
        </div>

        <div class="panel-search-wrap">
          <svg class="panel-search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          <input class="panel-search-input" id="offer-search" type="text" placeholder="Search items to offerâ€¦" autocomplete="off" spellcheck="false" />
          <div class="search-results-dropdown" id="offer-dropdown"></div>
        </div>

        <div class="panel-selected-wrap" id="offer-selected"></div>
      </div>

      <!-- â”€â”€ VS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div class="trade-vs">
        <div class="vs-dot-top"></div>
        <div class="vs-pill">VS</div>
        <div class="vs-dot-bot"></div>
      </div>

      <!-- â”€â”€ REQUESTING PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div class="trade-panel panel-request">
        <div class="panel-header">
          <div class="panel-label">
            <div class="panel-dot"></div>
            You Request
          </div>
          <div class="panel-header-right">
            <div class="panel-ctrl-btns">
              <button class="panel-ctrl-btn mirror-btn" id="mirror-request-to-offer" title="Copy request items to offer side">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="11" height="11"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg>
                <span>Mirror</span>
              </button>
              <button class="panel-ctrl-btn clear-btn" id="clear-request" title="Clear request items">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="11" height="11"><path d="M3 6h18"/><path d="M19 6l-1 14H6L5 6"/></svg>
                <span>Clear</span>
              </button>
            </div>
            <div class="panel-total-group">
              <span class="panel-total-lbl">Total Value</span>
              <span class="panel-total-val" id="request-total">0</span>
            </div>
          </div>
        </div>

        <div class="panel-search-wrap">
          <svg class="panel-search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          <input class="panel-search-input" id="request-search" type="text" placeholder="Search items you wantâ€¦" autocomplete="off" spellcheck="false" />
          <div class="search-results-dropdown" id="request-dropdown"></div>
        </div>

        <div class="panel-selected-wrap" id="request-selected"></div>
      </div>

    </div><!-- /trade-arena -->

    <!-- Trade Summary -->
    <div class="trade-summary" id="trade-summary"></div>

  </main>

  <footer class="site-footer">
    <span>Â© 2025 JBLX â€” Jailbreak Listing Exchange</span>
    <span>Not affiliated with Badimo or Roblox</span>
  </footer>

  <!-- Shared values database -->
  <script src="js/values.js"></script>
  <script>
/* ================================================================
   JBLX TRADE CALCULATOR ENGINE
   Features: quantity stacking Â· clean/duped/limited toggle Â·
             mirror sides Â· individual/global clear Â· full summary
================================================================ */

// â”€â”€ DEMAND WEIGHTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEMAND_WEIGHT = {
  'Very High':7, High:6, Solid:5, Medium:4, Average:3, Low:2, Minimal:1, Nonexistent:0
};
const DEMAND_NAMES = Object.fromEntries(
  Object.entries(DEMAND_WEIGHT).map(([k,v]) => [v, k])
);

// â”€â”€ PULL VALUE HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parsePullAmt(str) {
  if (!str) return 0;
  str = str.trim();
  const sign = str[0] === '-' ? -1 : (str[0] === '=' ? 0 : 1);
  if (str[0] === '=') return 0;
  const num = parseFloat(str.replace(/[^0-9.]/g, '')) || 0;
  if (/[Mm]/.test(str)) return sign * num * 1_000_000;
  if (/[Kk]/.test(str)) return sign * num * 1_000;
  return sign * num;
}

function getEntryPull(entry) {
  const pv = entry.item.pullValue;
  if (!pv) return 0;
  const isAlt = entry.state === 'duped' || entry.state === 'limited';
  if (pv.includes('/')) {
    const parts = pv.split('/');
    return parsePullAmt(isAlt ? parts[1] : parts[0]);
  }
  return parsePullAmt(pv);
}

// â”€â”€ VERDICT THRESHOLDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const VERDICT = [
  { min:  8,        cls:'s-win',         label:'Win',         emoji:'ðŸ†' },
  { min:  2,        cls:'s-slight-win',  label:'Slight Win',  emoji:'ðŸ“ˆ' },
  { min: -2,        cls:'s-fair',        label:'Fair',        emoji:'âš–ï¸'  },
  { min: -8,        cls:'s-slight-lose', label:'Slight Lose', emoji:'ðŸ“‰' },
  { min: -Infinity, cls:'s-lose',        label:'Lose',        emoji:'âŒ' },
];

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Each entry: { uid, item, state ('clean'|'duped'|'limited'), value (per-item), qty }
const SIDES = { offer: [], request: [] };
let _nextUID = 1;
const uid = () => _nextUID++;

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const abbr = name => name.replace(/[^A-Z0-9]/gi,'').slice(0,3).toUpperCase();

function demandScore(item) { return DEMAND_WEIGHT[item.demand] ?? -1; }

function avgDemand(entries) {
  // Weighted by qty â€” uses dupedDemand when item is toggled to duped state
  const rated = entries.filter(e => DEMAND_WEIGHT[e.item.demand] !== undefined);
  if (!rated.length) return null;
  const totalQty = rated.reduce((s,e) => s + e.qty, 0);
  return rated.reduce((s,e) => {
    const isDuped = e.state === 'duped';
    const demandKey = (isDuped && e.item.dupedDemand) ? e.item.dupedDemand : e.item.demand;
    return s + (DEMAND_WEIGHT[demandKey] ?? 0) * e.qty;
  }, 0) / totalQty;
}

function demandName(score) {
  if (score === null) return 'N/A';
  return DEMAND_NAMES[Math.round(Math.max(0, Math.min(7, score)))] ?? 'N/A';
}

function escHtml(s) {
  return String(s)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function search(q) {
  if (!q) return [];
  const lo = q.toLowerCase();
  return ITEMS.filter(i => i.name.toLowerCase().includes(lo)).slice(0, 35);
}

// â”€â”€ ITEM ADD / REMOVE / QTY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function addItem(side, item) {
  const isLimited = isObtainableLimited(item);
  const initState = (isLimited && item.duped !== null) ? 'limited' : 'clean';
  const initValue = (isLimited && item.duped !== null) ? item.duped : item.value;

  // Stack: if same item+state already exists, increment qty
  const existing = SIDES[side].find(e => e.item.name === item.name && e.state === initState);
  if (existing) {
    existing.qty++;
  } else {
    SIDES[side].push({ uid: uid(), item, state: initState, value: initValue, qty: 1 });
  }
  refreshSelected(side);
  refreshTotal(side);
  refreshSummary();
}

function removeItem(side, id) {
  SIDES[side] = SIDES[side].filter(e => e.uid !== id);
  refreshSelected(side);
  refreshTotal(side);
  refreshSummary();
}

function adjustQty(side, id, delta) {
  const e = SIDES[side].find(x => x.uid === id);
  if (!e) return;
  const next = e.qty + delta;
  if (next <= 0) {
    removeItem(side, id);
    return;
  }
  e.qty = next;
  refreshSelected(side);
  refreshTotal(side);
  refreshSummary();
}

function toggleCondition(side, id) {
  const e = SIDES[side].find(x => x.uid === id);
  if (!e) return;
  const isLimited = isObtainableLimited(e.item);
  const altState  = isLimited ? 'limited' : 'duped';

  if (e.state === 'clean' && e.item.duped !== null) {
    e.state = altState;
    e.value = e.item.duped;
  } else {
    e.state = 'clean';
    e.value = e.item.value;
  }
  refreshSelected(side);
  refreshTotal(side);
  refreshSummary();
}

// â”€â”€ MIRROR / CLEAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function mirrorSide(from, to) {
  // Deep copy entries to the other side with new UIDs
  SIDES[to] = SIDES[from].map(e => ({ ...e, uid: uid() }));
  refreshSelected(to);
  refreshTotal(to);
  refreshSummary();
}

function clearSide(side) {
  SIDES[side] = [];
  refreshSelected(side);
  refreshTotal(side);
  refreshSummary();
}

// â”€â”€ DROPDOWN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderDropdown(side, results, q) {
  const dd = document.getElementById(`${side}-dropdown`);
  if (!q.trim()) { dd.classList.remove('open'); return; }
  dd.classList.add('open');

  if (!results.length) {
    dd.innerHTML = `<div class="srd-empty">No items found for "<strong>${escHtml(q)}</strong>"</div>`;
    return;
  }

  dd.innerHTML = `
    <div class="srd-header">${results.length} result${results.length !== 1 ? 's' : ''} â€” click Add multiple times to stack</div>
    <div class="srd-scroll" id="${side}-srd-scroll"></div>`;

  const scroll = dd.querySelector('.srd-scroll');
  results.forEach(item => {
    const imgBlock = item.image
      ? `<img src="${item.image}" alt="" loading="lazy"
           onerror="this.style.display='none';this.nextElementSibling.style.removeProperty('display')">
         <span class="srd-thumb-fb" style="display:none">${abbr(item.name)}</span>`
      : `<span class="srd-thumb-fb">${abbr(item.name)}</span>`;

    const row = document.createElement('div');
    row.className = 'srd-row';
    row.innerHTML = `
      <div class="srd-thumb">${imgBlock}</div>
      <div>
        <div class="srd-name">${escHtml(item.name)}</div>
        <div class="srd-type">${item.type}</div>
      </div>
      <span class="srd-val">${fmtValue(item.value)}</span>
      <span class="srd-demand badge-demand ${demandClass(item.demand)}" style="font-size:0.55rem">${item.demand}</span>
      <button class="srd-add">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
          stroke-linecap="round" stroke-linejoin="round" width="10" height="10">
          <path d="M12 5v14M5 12h14"/>
        </svg>Add
      </button>`;

    // Keep dropdown open after add so user can click multiple times
    row.querySelector('.srd-add').addEventListener('click', (ev) => {
      ev.stopPropagation();
      addItem(side, item);
      // Brief flash on add button to confirm
      const btn = ev.currentTarget;
      btn.textContent = 'âœ“';
      btn.style.background = '#39e07a';
      btn.style.color = '#000';
      setTimeout(() => {
        btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
          stroke-linecap="round" stroke-linejoin="round" width="10" height="10">
          <path d="M12 5v14M5 12h14"/>
        </svg>Add`;
        btn.style.background = '';
        btn.style.color = '';
      }, 600);
    });
    scroll.appendChild(row);
  });
}

// â”€â”€ SELECTED ITEMS LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function refreshSelected(side) {
  const wrap    = document.getElementById(`${side}-selected`);
  const entries = SIDES[side];

  if (!entries.length) {
    wrap.innerHTML = `
      <div class="panel-empty-state">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" width="38" height="38">
          <circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/>
        </svg>
        <div>
          <div class="panel-empty-state-title">Nothing here yet</div>
          <div class="panel-empty-state-sub">Search above to add items</div>
        </div>
      </div>`;
    return;
  }

  const list = document.createElement('div');
  list.className = 'selected-list';

  entries.forEach(e => {
    const { uid: id, item, state, value, qty } = e;
    const totalVal  = value * qty;
    const hasDuped  = item.duped !== null;
    const isLimited = isObtainableLimited(item);
    const altLabel  = isLimited ? 'Limited' : 'Duped';
    const altState  = isLimited ? 'limited' : 'duped';
    const isAlt     = state === 'duped' || state === 'limited';

    const imgBlock = item.image
      ? `<img src="${item.image}" alt="" loading="lazy"
           onerror="this.style.display='none';this.nextElementSibling.style.removeProperty('display')">
         <span class="sel-thumb-fb" style="display:none">${abbr(item.name)}</span>`
      : `<span class="sel-thumb-fb">${abbr(item.name)}</span>`;

    const row = document.createElement('div');
    row.className = `sel-row${isAlt ? ' is-duped' : ''}`;
    row.dataset.uid = id;

    row.innerHTML = `
      <div class="sel-thumb-wrap">
        ${imgBlock}
        <div class="sel-duped-strip">${isLimited ? 'LTD' : 'DUP'}</div>
      </div>
      <div class="sel-info">
        <div class="sel-name-row">
          <span class="sel-name">${escHtml(item.name)}</span>
          ${qty > 1 ? `<span class="sel-qty-badge">Ã—${qty}</span>` : ''}
        </div>
        <div class="sel-value-row">
          <span class="sel-value">${fmtValue(totalVal)}</span>
          ${qty > 1 ? `<span class="sel-each">${fmtValue(value)} ea</span>` : ''}
        </div>
      </div>
      <div class="sel-controls">
        <button class="sel-remove" title="Remove item">âœ•</button>
        <div class="cd-toggle">
          <button class="cd-btn${state === 'clean' ? ' active-clean' : ''}" data-cd="clean">Clean</button>
          <button class="cd-btn${isAlt ? ' active-duped' : ''}"
            data-cd="${altState}"${!hasDuped ? ' disabled title="No value in database"' : ''}>${altLabel}</button>
        </div>
        <div class="qty-stepper">
          <button class="qty-btn qty-minus" title="Remove one">âˆ’</button>
          <span class="qty-display">${qty}</span>
          <button class="qty-btn qty-plus" title="Add one">+</button>
        </div>
      </div>`;

    row.querySelector('.sel-remove').addEventListener('click', () => removeItem(side, id));

    row.querySelector('[data-cd="clean"]').addEventListener('click', () => {
      if (e.state !== 'clean') toggleCondition(side, id);
    });
    if (hasDuped) {
      row.querySelector(`[data-cd="${altState}"]`).addEventListener('click', () => {
        if (e.state !== altState) toggleCondition(side, id);
      });
    }

    row.querySelector('.qty-minus').addEventListener('click', () => adjustQty(side, id, -1));
    row.querySelector('.qty-plus').addEventListener('click',  () => adjustQty(side, id,  1));

    list.appendChild(row);
  });

  wrap.innerHTML = '';
  wrap.appendChild(list);
}

// â”€â”€ TOTALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function refreshTotal(side) {
  const total = SIDES[side].reduce((s, e) => s + e.value * e.qty, 0);
  document.getElementById(`${side}-total`).textContent = fmtValue(total);
}

// â”€â”€ SUMMARY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function refreshSummary() {
  const el      = document.getElementById('trade-summary');
  const offer   = SIDES.offer;
  const request = SIDES.request;

  if (!offer.length && !request.length) {
    el.innerHTML = '<div class="summary-placeholder">Add items to both sides to see your trade verdict.</div>';
    return;
  }
  if (!offer.length || !request.length) {
    el.innerHTML = '<div class="summary-placeholder">Add items to the other panel to compare.</div>';
    return;
  }

  // Totals (qty-weighted)
  const offerTotal   = offer.reduce((s,e)   => s + e.value * e.qty, 0);
  const requestTotal = request.reduce((s,e) => s + e.value * e.qty, 0);
  const offerPull   = offer.reduce((s,e)   => s + getEntryPull(e) * e.qty, 0);
  const requestPull = request.reduce((s,e) => s + getEntryPull(e) * e.qty, 0);
  const offerEffective   = offerTotal   + offerPull;
  const requestEffective = requestTotal + requestPull;
  const pullDiff = offerPull - requestPull;
  const rawDiff      = requestTotal - offerTotal;

  // Item counts (qty-weighted)
  const offerCount   = offer.reduce((s,e)   => s + e.qty, 0);
  const requestCount = request.reduce((s,e) => s + e.qty, 0);
  const extraOffer   = Math.max(0, offerCount - requestCount);
  const extraRequest = Math.max(0, requestCount - offerCount);

  // Upgrade / downgrade adjustment
  const UPGRADE_RATE   = 0.04;
  const DOWNGRADE_RATE = 0.037;
  let adjDiff   = rawDiff;
  let allowance = 0;
  let tax       = 0;
  const isUpgrade   = extraOffer   > 0;
  const isDowngrade = extraRequest > 0;

  if (isUpgrade) {
    allowance = extraOffer * UPGRADE_RATE * offerTotal;
    adjDiff   = rawDiff + allowance;
  } else if (isDowngrade) {
    tax     = extraRequest * DOWNGRADE_RATE * offerTotal;
    adjDiff = rawDiff - tax;
  }

  // Percentage & verdict
  const pct = offerTotal > 0
    ? (adjDiff / offerTotal) * 100
    : (requestTotal > 0 ? 100 : 0);
  const v = VERDICT.find(x => pct >= x.min);

  // Demand analysis (qty-weighted averages)
  const offerDS   = avgDemand(offer);
  const requestDS = avgDemand(request);
  const demandWarn = offerDS !== null && requestDS !== null && adjDiff > 0 && requestDS < offerDS;

  // Confidence
  const ap = Math.abs(pct);
  let confLabel, confPct, confColor;
  if      (ap >= 15) { confLabel = 'High';     confPct = 92; confColor = '#39e07a'; }
  else if (ap >=  6) { confLabel = 'Medium';   confPct = 62; confColor = '#e07820'; }
  else if (ap >=  2) { confLabel = 'Low';      confPct = 36; confColor = '#e03040'; }
  else               { confLabel = 'Very Low'; confPct = 14; confColor = '#6b7280'; }

  // Duped/Limited item count
  const totalAlt = [...offer, ...request]
    .filter(e => e.state === 'duped' || e.state === 'limited')
    .reduce((s,e) => s + e.qty, 0);

  // Diff display
  const diffSign = adjDiff >= 0 ? '+' : 'âˆ’';
  const diffAbs  = fmtValue(Math.abs(Math.round(adjDiff)));
  const diffCls  = adjDiff >= 0 ? 'up' : 'dn';
  const pctSign  = pct >= 0 ? '+' : '';

  el.innerHTML = `
    <div class="summary-card ${v.cls}">

      <!-- Verdict + Metrics -->
      <div class="summary-top">
        <div class="verdict-block">
          <div class="verdict-emoji">${v.emoji}</div>
          <div>
            <div class="verdict-status">${v.label}</div>
            <div class="verdict-sub">Trade Verdict</div>
          </div>
        </div>
        <div class="metrics-strip">
          <div class="metric-cell">
            <div class="mc-lbl">You Offer</div>
            <div class="mc-val">${fmtValue(offerTotal)}</div>
          </div>
          <div class="metric-cell">
            <div class="mc-lbl">You Request</div>
            <div class="mc-val">${fmtValue(requestTotal)}</div>
          </div>
          <div class="metric-cell">
            <div class="mc-lbl">Adj. Diff</div>
            <div class="mc-val ${diffCls}">${diffSign}${diffAbs}</div>
          </div>
          <div class="metric-cell">
            <div class="mc-lbl">% Diff</div>
            <div class="mc-val ${diffCls}">${pctSign}${pct.toFixed(1)}%</div>
          </div>
          <div class="metric-cell">
            <div class="mc-lbl">Confidence</div>
            <div class="mc-val" style="color:${confColor}">${confLabel}</div>
          </div>
        </div>
      </div>

      <!-- Alert banners -->
      ${isUpgrade ? `
      <div class="summary-alert alert-upgrade">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14" style="margin-top:1px"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
        <span><strong>Upgrade Trade</strong> â€” you're offering ${extraOffer} more item${extraOffer>1?'s':''} than you request.
        An upgrade allowance of <strong>${fmtValue(Math.round(allowance))}</strong> has been applied to your favour.</span>
      </div>` : ''}

      ${isDowngrade ? `
      <div class="summary-alert alert-downgrade">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14" style="margin-top:1px"><path d="M12 5v14M5 12l7 7 7-7"/></svg>
        <span><strong>Downgrade Trade</strong> â€” you're requesting ${extraRequest} more item${extraRequest>1?'s':''} than you offer.
        A downgrade tax of <strong>${fmtValue(Math.round(tax))}</strong> has been applied against you.</span>
      </div>` : ''}

      ${demandWarn ? `
      <div class="summary-alert alert-demand">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14" style="margin-top:1px"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
        <span><strong>Demand Warning</strong> â€” items you're requesting have lower average demand than what you're offering.
        This trade may be harder to complete in practice.</span>
      </div>` : ''}

      <!-- Detail grid -->
      <div class="summary-detail-grid">
        <div class="detail-block">
          <div class="db-lbl">Raw Difference</div>
          <div class="db-val ${rawDiff >= 0 ? 'up' : 'dn'}">${rawDiff >= 0 ? '+' : 'âˆ’'}${fmtValue(Math.abs(Math.round(rawDiff)))}</div>
        </div>
        <div class="detail-block">
          <div class="db-lbl">Offer Demand</div>
          <div class="db-val">${demandName(offerDS)}</div>
        </div>
        <div class="detail-block">
          <div class="db-lbl">Request Demand</div>
          <div class="db-val">${demandName(requestDS)}</div>
        </div>
        <div class="detail-block">
          <div class="db-lbl">Confidence</div>
          <div class="db-val" style="color:${confColor}">
            ${confLabel}
            <div class="conf-track"><div class="conf-fill" style="width:${confPct}%;background:${confColor}"></div></div>
          </div>
        </div>
        <div class="detail-block">
          <div class="db-lbl">Items Offered</div>
          <div class="db-val neu">${offerCount}</div>
        </div>
        <div class="detail-block">
          <div class="db-lbl">Items Requested</div>
          <div class="db-val neu">${requestCount}</div>
        </div>
        ${totalAlt > 0 ? `
        <div class="detail-block">
          <div class="db-lbl">Duped / Limited</div>
          <div class="db-val warn">${totalAlt} item${totalAlt > 1 ? 's' : ''}</div>
        </div>` : ''}
        ${isUpgrade ? `
        <div class="detail-block">
          <div class="db-lbl">Upgrade Allowance</div>
          <div class="db-val up">+${fmtValue(Math.round(allowance))}</div>
        </div>` : ''}
        ${isDowngrade ? `
        <div class="detail-block">
          <div class="db-lbl">Downgrade Tax</div>
          <div class="db-val dn">âˆ’${fmtValue(Math.round(tax))}</div>
        </div>` : ''}
        <div class="detail-block">
          <div class="db-lbl">Pull Advantage</div>
          <div class="db-val ${pullDiff > 0 ? 'up' : pullDiff < 0 ? 'dn' : 'neu'}">${pullDiff === 0 ? 'â€”' : (pullDiff > 0 ? '+' : '') + fmtValue(Math.round(pullDiff))}</div>
        </div>
      </div>

    </div>`;
}

// â”€â”€ SEARCH INPUT WIRING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

['offer','request'].forEach(side => {
  const inp = document.getElementById(`${side}-search`);
  const dd  = document.getElementById(`${side}-dropdown`);

  inp.addEventListener('input', () => {
    renderDropdown(side, search(inp.value.trim()), inp.value.trim());
  });
  inp.addEventListener('focus', () => {
    if (inp.value.trim()) renderDropdown(side, search(inp.value.trim()), inp.value.trim());
  });
  // Close dropdown when clicking outside
  document.addEventListener('pointerdown', ev => {
    const wrap = inp.closest('.panel-search-wrap');
    if (!wrap.contains(ev.target)) dd.classList.remove('open');
  }, { capture: true });
});

// â”€â”€ BUTTON WIRING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Global clear
document.getElementById('btn-clear').addEventListener('click', () => {
  SIDES.offer = []; SIDES.request = [];
  ['offer','request'].forEach(s => {
    refreshSelected(s);
    refreshTotal(s);
    document.getElementById(`${s}-search`).value = '';
    document.getElementById(`${s}-dropdown`).classList.remove('open');
  });
  refreshSummary();
});

// Individual clear
document.getElementById('clear-offer').addEventListener('click', () => {
  clearSide('offer');
});
document.getElementById('clear-request').addEventListener('click', () => {
  clearSide('request');
});

// Mirror buttons
document.getElementById('mirror-offer-to-request').addEventListener('click', () => {
  mirrorSide('offer', 'request');
});
document.getElementById('mirror-request-to-offer').addEventListener('click', () => {
  mirrorSide('request', 'offer');
});

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
refreshSelected('offer');
refreshSelected('request');
refreshSummary();
  </script>
  <script src="js/mobile-nav.js"></script>
</body>
</html>